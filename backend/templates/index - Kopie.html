<!DOCTYPE html>
<html lang="de" data-theme="dark">
<head>
    <meta charset="utf-8" />
    <title>Local Activity Tracker</title>
    <style>
        :root {
            --bg-body: #0f172a;
            --bg-header: linear-gradient(120deg, #020617 0%, #0f172a 40%, #0b1120 100%);
            --bg-card: #0b1120;
            --bg-card-inner: #020617;
            --bg-card-soft: #020617;
            --border-subtle: #1e293b;
            --accent: #38bdf8;
            --accent-soft: rgba(56, 189, 248, 0.12);
            --accent-strong: #0ea5e9;
            --text-main: #e5e7eb;
            --text-muted: #9ca3af;
            --text-soft: #6b7280;
            --danger: #f97373;
            --radius-xl: 18px;
            --radius-lg: 12px;
            --shadow-soft: 0 18px 40px rgba(15, 23, 42, 0.7);
        }

        /* Light Theme Overrides */
        html[data-theme="light"] {
            color-scheme: light;
            --bg-body: #f3f4f6;
            --bg-header: linear-gradient(120deg, #eef2ff 0%, #e5e7eb 40%, #e5f3ff 100%);
            --bg-card: #ffffff;
            --bg-card-inner: #ffffff;
            --bg-card-soft: #f9fafb;
            --border-subtle: #e5e7eb;
            --accent: #0284c7;
            --accent-soft: rgba(2, 132, 199, 0.12);
            --accent-strong: #0369a1;
            --text-main: #0f172a;
            --text-muted: #4b5563;
            --text-soft: #9ca3af;
            --shadow-soft: 0 18px 40px rgba(15, 23, 42, 0.15);
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            background: radial-gradient(circle at top left, #1e293b 0, #020617 40%, #000 100%);
            color: var(--text-main);
        }

        html[data-theme="light"] body {
            background: radial-gradient(circle at top left, #e5e7eb 0, #f3f4f6 40%, #e5e7eb 100%);
        }

        .app-shell {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .app-header {
            padding: 20px 28px 12px 28px;
            background: var(--bg-header);
            border-bottom: 1px solid rgba(148, 163, 184, 0.18);
            box-shadow: 0 14px 40px rgba(15, 23, 42, 0.85);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        html[data-theme="light"] .app-header {
            box-shadow: 0 12px 30px rgba(15, 23, 42, 0.12);
            border-bottom-color: rgba(148, 163, 184, 0.35);
        }

        .app-header-main {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 16px;
        }

        .app-title {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .app-title h1 {
            font-size: 22px;
            font-weight: 600;
            letter-spacing: 0.02em;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .app-title h1 span.logo-dot {
            display: inline-flex;
            width: 12px;
            height: 12px;
            border-radius: 999px;
            background: radial-gradient(circle at 30% 30%, #e5f9ff 0, #38bdf8 35%, #0ea5e9 100%);
            box-shadow: 0 0 0 3px rgba(56, 189, 248, 0.35);
        }

        html[data-theme="light"] .app-title h1 span.logo-dot {
            box-shadow: 0 0 0 3px rgba(56, 189, 248, 0.3);
        }

        .app-title small {
            margin: 0;
            color: var(--text-soft);
            font-size: 12px;
        }

        .header-status {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 12px;
        }

        .status-pill {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            border-radius: 999px;
            background: rgba(15, 118, 110, 0.16);
            color: #6ee7b7;
            font-weight: 500;
        }

        html[data-theme="light"] .status-pill {
            background: rgba(34, 197, 94, 0.08);
            color: #059669;
        }

        .status-pill-dot {
            width: 8px;
            height: 8px;
            border-radius: 999px;
            background: #22c55e;
            box-shadow: 0 0 0 4px rgba(34, 197, 94, 0.18);
        }

        #status {
            color: var(--text-muted);
        }

        .theme-toggle-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 30px;
            height: 30px;
            border-radius: 999px;
            border: 1px solid rgba(148, 163, 184, 0.45);
            background: radial-gradient(circle at top left, rgba(15, 23, 42, 0.8) 0, rgba(15, 23, 42, 0.95) 40%, rgba(15, 23, 42, 1) 100%);
            color: #e5e7eb;
            cursor: pointer;
            box-shadow: 0 10px 22px rgba(15, 23, 42, 0.8);
            transition: transform 0.08s ease-out, box-shadow 0.08s ease-out, background 0.1s ease-out;
        }

        html[data-theme="light"] .theme-toggle-btn {
            background: radial-gradient(circle at top left, #ffffff 0, #f9fafb 40%, #e5e7eb 100%);
            color: #0f172a;
            box-shadow: 0 8px 18px rgba(15, 23, 42, 0.18);
        }

        .theme-toggle-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 12px 26px rgba(15, 23, 42, 0.85);
        }

        .theme-toggle-btn:active {
            transform: translateY(0);
            box-shadow: 0 6px 14px rgba(15, 23, 42, 0.7);
        }

        .theme-toggle-icon {
            font-size: 14px;
        }

        .app-main {
            padding: 18px 24px 24px 24px;
        }

        .grid-layout {
            display: grid;
            grid-template-columns: 2.1fr 2.4fr 1.5fr;
            gap: 18px;
        }

        @media (max-width: 1280px) {
            .grid-layout {
                grid-template-columns: 1fr;
            }
        }

        .card {
            background: var(--bg-card);
            border-radius: var(--radius-xl);
            padding: 14px 14px 12px 14px;
            border: 1px solid rgba(148, 163, 184, 0.18);
            box-shadow: var(--shadow-soft);
            position: relative;
            overflow: hidden;
        }

        .card::before {
            content: "";
            position: absolute;
            inset: -40%;
            opacity: 0.04;
            background:
                radial-gradient(circle at top left, #38bdf8 0, transparent 60%),
                radial-gradient(circle at bottom right, #22c55e 0, transparent 55%);
            pointer-events: none;
        }

        html[data-theme="light"] .card {
            border-color: rgba(148, 163, 184, 0.35);
        }

        .card-inner {
            position: relative;
            z-index: 1;
        }

        .card-header {
            display: flex;
            align-items: baseline;
            justify-content: space-between;
            gap: 8px;
            margin-bottom: 8px;
        }

        .card-header h2 {
            font-size: 14px;
            font-weight: 600;
            letter-spacing: 0.03em;
            margin: 0;
            text-transform: uppercase;
            color: var(--text-main);
        }

        .card-header small {
            font-size: 11px;
            color: var(--text-soft);
        }

        .card-tag {
            font-size: 11px;
            padding: 2px 8px;
            border-radius: 999px;
            background: rgba(15, 23, 42, 0.9);
            border: 1px solid rgba(148, 163, 184, 0.4);
            color: var(--text-muted);
            white-space: nowrap;
        }

        html[data-theme="light"] .card-tag {
            background: #f9fafb;
            border-color: rgba(148, 163, 184, 0.8);
            color: #4b5563;
        }

        .card-tag span {
            color: var(--accent);
            font-weight: 500;
        }

        .table-container {
            max-height: 260px;
            border-radius: var(--radius-lg);
            border: 1px solid rgba(51, 65, 85, 0.9);
            overflow: hidden;
            background: var(--bg-card-inner);
        }

        html[data-theme="light"] .table-container {
            border-color: rgba(209, 213, 219, 0.95);
            background: #ffffff;
        }

        .table-scroll {
            max-height: 260px;
            overflow-y: auto;
        }

        table {
            border-collapse: collapse;
            width: 100%;
            table-layout: fixed;
        }

        thead tr {
            background: linear-gradient(90deg, rgba(15, 23, 42, 0.96), rgba(15, 23, 42, 0.9));
        }

        html[data-theme="light"] thead tr {
            background: linear-gradient(90deg, #e5e7eb, #e5f3ff);
        }

        th, td {
            padding: 6px 10px;
            font-size: 12px;
            border-bottom: 1px solid rgba(30, 41, 59, 0.85);
            color: var(--text-muted);
            vertical-align: top;
        }

        html[data-theme="light"] th,
        html[data-theme="light"] td {
            border-bottom-color: rgba(209, 213, 219, 0.9);
        }

        th {
            font-weight: 500;
            text-align: left;
            color: var(--text-main);
            position: sticky;
            top: 0;
            z-index: 2;
        }

        tbody tr:hover {
            background: rgba(15, 23, 42, 0.9);
        }

        html[data-theme="light"] tbody tr:hover {
            background: rgba(243, 244, 246, 0.9);
        }

        .timestamp {
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
            font-size: 11px;
            color: var(--text-soft);
            white-space: nowrap;
        }

        .source-pill {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 2px 8px;
            border-radius: 999px;
            font-size: 11px;
            background: rgba(15, 23, 42, 0.95);
            color: var(--text-muted);
            border: 1px solid rgba(51, 65, 85, 0.9);
        }

        html[data-theme="light"] .source-pill {
            background: #f9fafb;
            border-color: rgba(148, 163, 184, 0.8);
            color: #4b5563;
        }

        .source-pill::before {
            content: "";
            width: 6px;
            height: 6px;
            border-radius: 999px;
            background: var(--accent);
        }

        .source-pill[data-source="input"]::before {
            background: #a855f7;
        }

        .source-pill[data-source="document"]::before {
            background: #22c55e;
        }

        .source-pill[data-source="window"]::before {
            background: #f97316;
        }

        .details-cell,
        .path-cell {
            word-wrap: break-word;
            word-break: break-word;
            white-space: normal;
        }

        .muted {
            color: var(--text-soft);
            font-size: 11px;
        }

        .settings-row {
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }

        .settings-row label {
            font-size: 12px;
            color: var(--text-muted);
        }

        input[type="number"] {
            padding: 4px 6px;
            border-radius: 999px;
            border: 1px solid rgba(148, 163, 184, 0.5);
            background: rgba(15, 23, 42, 0.95);
            color: var(--text-main);
            width: 80px;
            font-size: 12px;
        }

        html[data-theme="light"] input[type="number"] {
            background: #ffffff;
            border-color: rgba(148, 163, 184, 0.8);
            color: #0f172a;
        }

        input[type="number"]:focus {
            outline: none;
            border-color: var(--accent-strong);
            box-shadow: 0 0 0 1px rgba(56, 189, 248, 0.6);
        }

        button {
            padding: 4px 10px;
            border-radius: 999px;
            border: none;
            background: linear-gradient(135deg, var(--accent), var(--accent-strong));
            color: #0b1120;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            box-shadow: 0 10px 20px rgba(8, 47, 73, 0.65);
            transition: transform 0.08s ease-out, box-shadow 0.08s ease-out, filter 0.06s ease-out;
        }

        html[data-theme="light"] button {
            box-shadow: 0 8px 18px rgba(15, 23, 42, 0.18);
        }

        button:hover {
            transform: translateY(-1px);
            filter: brightness(1.02);
            box-shadow: 0 14px 30px rgba(8, 47, 73, 0.85);
        }

        button:active {
            transform: translateY(0);
            box-shadow: 0 6px 14px rgba(8, 47, 73, 0.6);
        }

        #settings-status {
            font-size: 11px;
            color: var(--text-soft);
            margin-top: 6px;
        }

        /* SpaltengrÃ¶ÃŸen fÃ¼r bessere Lesbarkeit */
        #timeline-table th:nth-child(1),
        #timeline-table td:nth-child(1),
        #input-table th:nth-child(1),
        #input-table td:nth-child(1),
        #document-table th:nth-child(1),
        #document-table td:nth-child(1) {
            width: 160px;
        }

        #timeline-table th:nth-child(2),
        #timeline-table td:nth-child(2) {
            width: 90px;
        }

        #timeline-table th:nth-child(3),
        #timeline-table td:nth-child(3),
        #input-table th:nth-child(2),
        #input-table td:nth-child(2),
        #document-table th:nth-child(2),
        #document-table td:nth-child(2) {
            width: 120px;
        }
    </style>
</head>
<body>
<div class="app-shell">
    <header class="app-header">
        <div class="app-header-main">
            <div class="app-title">
                <h1>
                    <span class="logo-dot"></span>
                    Local Activity Tracker
                </h1>
                <small id="status">Lade Datenâ€¦</small>
            </div>
            <div class="header-status">
                <div class="status-pill">
                    <span class="status-pill-dot"></span>
                    <span>Erfassung aktiv</span>
                </div>
                <button id="theme-toggle" class="theme-toggle-btn" title="Theme umschalten">
                    <span class="theme-toggle-icon">ðŸŒ™</span>
                </button>
            </div>
        </div>
    </header>

    <main class="app-main">
        <div class="grid-layout">
            <!-- Linke Spalte: Top Windows -->
            <section class="card">
                <div class="card-inner">
                    <div class="card-header">
                        <div>
                            <h2>Top Fenster / Anwendungen</h2>
                            <small>Basierend auf window_focus-Events</small>
                        </div>
                        <div class="card-tag">
                            Letzte <span>Sessions</span>
                        </div>
                    </div>
                    <div class="table-container">
                        <div class="table-scroll">
                            <table id="top-windows-table">
                                <thead>
                                <tr>
                                    <th>App</th>
                                    <th>Titel</th>
                                    <th>Minuten</th>
                                    <th>Stunden</th>
                                </tr>
                                </thead>
                                <tbody>
                                <tr><td colspan="4" class="muted">Noch keine Datenâ€¦</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Mitte: Timeline -->
            <section class="card">
                <div class="card-inner">
                    <div class="card-header">
                        <div>
                            <h2>Timeline</h2>
                            <small>Neueste Events zuerst Â· Limit 200</small>
                        </div>
                        <div class="card-tag">
                            Quelle: <span>Alle</span>
                        </div>
                    </div>
                    <div class="table-container">
                        <div class="table-scroll">
                            <table id="timeline-table">
                                <thead>
                                <tr>
                                    <th>Zeit</th>
                                    <th>Quelle</th>
                                    <th>Typ</th>
                                    <th>Details</th>
                                </tr>
                                </thead>
                                <tbody>
                                <tr><td colspan="4" class="muted">Noch keine Datenâ€¦</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Rechts: Einstellungen -->
            <section class="card">
                <div class="card-inner">
                    <div class="card-header">
                        <div>
                            <h2>Einstellungen</h2>
                            <small>Aufbewahrung & Steuerung</small>
                        </div>
                        <div class="card-tag">
                            Screenshots <span>WebP</span>
                        </div>
                    </div>
                    <div class="settings-row">
                        <label for="retention-input">Screenshots behalten fÃ¼r (Tage):</label>
                        <input id="retention-input" type="number" min="1" value="7" />
                        <button id="save-settings-btn">Speichern</button>
                    </div>
                    <div id="settings-status">Noch nicht geladen.</div>

                    <div style="margin-top:14px; font-size:11px; color:var(--text-soft);">
                        Die Aufbewahrungsdauer steuert, wann alte Screenshot-Tagesordner automatisch
                        gelÃ¶scht werden. Der Screenshot-Collector liest diesen Wert regelmÃ¤ÃŸig ein.
                    </div>
                </div>
            </section>

            <!-- Zweite Reihe: Routinen + Automation -->
            <section class="card">
                <div class="card-inner">
                    <div class="card-header">
                        <div>
                            <h2>Wiederkehrende Routinen</h2>
                            <small>Sequenzen von Fensterwechseln (n=3, letzte 3 Tage)</small>
                        </div>
                        <div class="card-tag">
                            Muster <span>Erkennung</span>
                        </div>
                    </div>
                    <div class="table-container">
                        <div class="table-scroll">
                            <table id="routines-table">
                                <thead>
                                <tr>
                                    <th>Sequenz</th>
                                    <th>HÃ¤ufigkeit</th>
                                    <th>Stunden</th>
                                </tr>
                                </thead>
                                <tbody>
                                <tr><td colspan="3" class="muted">Noch keine Routinen gefunden.</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>

            <section class="card">
                <div class="card-inner">
                    <div class="card-header">
                        <div>
                            <h2>Automatisierungskandidaten</h2>
                            <small>Sortiert nach mÃ¶glicher Ersparnis pro Jahr</small>
                        </div>
                        <div class="card-tag">
                            Fokus <span>ROI</span>
                        </div>
                    </div>
                    <div class="table-container">
                        <div class="table-scroll">
                            <table id="automation-table">
                                <thead>
                                <tr>
                                    <th>App</th>
                                    <th>Titel</th>
                                    <th>Min/Tag</th>
                                    <th>h/Jahr</th>
                                    <th>Ersparnis/Jahr (â‚¬)</th>
                                </tr>
                                </thead>
                                <tbody>
                                <tr><td colspan="5" class="muted">Noch keine Kandidaten gefunden.</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Dritte Reihe: Input & Dokumente -->
            <section class="card">
                <div class="card-inner">
                    <div class="card-header">
                        <div>
                            <h2>Input-AktivitÃ¤ten</h2>
                            <small>Maus- & Tastatur-Events (neueste 200)</small>
                        </div>
                        <div class="card-tag">
                            Quelle: <span>input</span>
                        </div>
                    </div>
                    <div class="table-container">
                        <div class="table-scroll">
                            <table id="input-table">
                                <thead>
                                <tr>
                                    <th>Zeit</th>
                                    <th>Typ</th>
                                    <th>App/Fenster</th>
                                    <th>Details</th>
                                </tr>
                                </thead>
                                <tbody>
                                <tr><td colspan="4" class="muted">Noch keine Datenâ€¦</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>

            <section class="card">
                <div class="card-inner">
                    <div class="card-header">
                        <div>
                            <h2>Dokument-AktivitÃ¤ten</h2>
                            <small>Erstellen / Ã„ndern / Verschieben / LÃ¶schen (neueste 100)</small>
                        </div>
                        <div class="card-tag">
                            Quelle: <span>document</span>
                        </div>
                    </div>
                    <div class="table-container">
                        <div class="table-scroll">
                            <table id="document-table">
                                <thead>
                                <tr>
                                    <th>Zeit</th>
                                    <th>Typ</th>
                                    <th>Datei</th>
                                    <th>Pfad</th>
                                </tr>
                                </thead>
                                <tbody>
                                <tr><td colspan="4" class="muted">Keine Dokument-Events gefunden.</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </main>
</div>

<script>
    // Theme-Handling
    function applyTheme(theme) {
        const html = document.documentElement;
        const btnIcon = document.querySelector(".theme-toggle-icon");
        html.setAttribute("data-theme", theme);
        localStorage.setItem("lat-theme", theme);
        if (btnIcon) {
            btnIcon.textContent = theme === "light" ? "â˜€" : "ðŸŒ™";
        }
    }

    function initTheme() {
        const saved = localStorage.getItem("lat-theme");
        const prefersDark = window.matchMedia && window.matchMedia("(prefers-color-scheme: dark)").matches;
        let theme = "dark";

        if (saved === "dark" || saved === "light") {
            theme = saved;
        } else {
            theme = prefersDark ? "dark" : "light";
        }
        applyTheme(theme);
    }

    async function fetchJSON(url) {
        const res = await fetch(url);
        if (!res.ok) throw new Error("HTTP " + res.status);
        return res.json();
    }

    function formatTimestamp(ts) {
        try {
            const d = new Date(ts);
            return d.toLocaleString();
        } catch {
            return ts;
        }
    }

    function shortPayload(payload) {
        if (!payload) return "";
        if (payload.app || payload.title) {
            return [payload.app, payload.title].filter(Boolean).join(" â€“ ");
        }
        if (payload.path) {
            return payload.path;
        }
        if (payload.key) {
            return "Key: " + payload.key;
        }
        if (payload.button) {
            return "Mouse " + payload.button + " @ (" + payload.x + "," + payload.y + ")";
        }
        return JSON.stringify(payload).slice(0, 80) + "...";
    }

    function renderTopWindows(data) {
        const tbody = document.querySelector("#top-windows-table tbody");
        tbody.innerHTML = "";

        if (!data || data.length === 0) {
            const tr = document.createElement("tr");
            tr.innerHTML = '<td colspan="4" class="muted">Keine Daten verfÃ¼gbar.</td>';
            tbody.appendChild(tr);
            return;
        }

        data.forEach(row => {
            const tr = document.createElement("tr");
            const app = row.app || "(unbekannt)";
            const title = row.title || "";
            tr.innerHTML = `
                <td>${app}</td>
                <td>${title}</td>
                <td>${row.total_minutes.toFixed(1)}</td>
                <td>${row.total_hours.toFixed(2)}</td>
            `;
            tbody.appendChild(tr);
        });
    }

    function renderTimeline(data) {
        const tbody = document.querySelector("#timeline-table tbody");
        tbody.innerHTML = "";

        if (!data || data.length === 0) {
            const tr = document.createElement("tr");
            tr.innerHTML = '<td colspan="4" class="muted">Keine Daten verfÃ¼gbar.</td>';
            tbody.appendChild(tr);
            return;
        }

        data.forEach(ev => {
            const tr = document.createElement("tr");
            tr.innerHTML = `
                <td><span class="timestamp">${formatTimestamp(ev.timestamp)}</span></td>
                <td><span class="source-pill" data-source="${ev.source}">${ev.source}</span></td>
                <td>${ev.type}</td>
                <td class="details-cell">${shortPayload(ev.payload)}</td>
            `;
            tbody.appendChild(tr);
        });
    }

    function renderRoutines(data) {
        const tbody = document.querySelector("#routines-table tbody");
        tbody.innerHTML = "";

        if (!data || data.length === 0) {
            const tr = document.createElement("tr");
            tr.innerHTML = '<td colspan="3" class="muted">Noch keine Routinen gefunden.</td>';
            tbody.appendChild(tr);
            return;
        }

        data.forEach(r => {
            const tr = document.createElement("tr");
            const seqText = r.sequence
                .map(s => (s.app || "??") + " â€“ " + (s.title || ""))
                .join("  â†’  ");
            tr.innerHTML = `
                <td>${seqText}</td>
                <td>${r.count}</td>
                <td>${r.total_hours.toFixed(2)}</td>
            `;
            tbody.appendChild(tr);
        });
    }

    function renderAutomation(data) {
        const tbody = document.querySelector("#automation-table tbody");
        tbody.innerHTML = "";

        if (!data || data.length === 0) {
            const tr = document.createElement("tr");
            tr.innerHTML = '<td colspan="5" class="muted">Noch keine Kandidaten gefunden.</td>';
            tbody.appendChild(tr);
            return;
        }

        data.forEach(c => {
            const tr = document.createElement("tr");
            tr.innerHTML = `
                <td>${c.app || "??"}</td>
                <td>${c.title || ""}</td>
                <td>${c.avg_minutes_per_day.toFixed(1)}</td>
                <td>${c.yearly_hours.toFixed(1)}</td>
                <td>${c.potential_savings_per_year.toFixed(0)}</td>
            `;
            tbody.appendChild(tr);
        });
    }

    function renderInput(data) {
        const tbody = document.querySelector("#input-table tbody");
        tbody.innerHTML = "";

        if (!data || data.length === 0) {
            const tr = document.createElement("tr");
            tr.innerHTML = '<td colspan="4" class="muted">Keine Input-Daten gefunden.</td>';
            tbody.appendChild(tr);
            return;
        }

        data.forEach(ev => {
            const p = ev.payload || {};
            const appTitle = [p.app, p.title].filter(Boolean).join(" â€“ ");
            let detail = "";
            if (p.key) {
                detail = "Key: " + p.key;
            } else if (p.button) {
                detail = "Mouse " + p.button + " @ (" + p.x + "," + p.y + ")";
            } else if (typeof p.x === "number" && typeof p.y === "number") {
                detail = "Move @ (" + p.x + "," + p.y + ")";
            } else {
                detail = shortPayload(p);
            }

            const tr = document.createElement("tr");
            tr.innerHTML = `
                <td><span class="timestamp">${formatTimestamp(ev.timestamp)}</span></td>
                <td>${ev.type}</td>
                <td>${appTitle}</td>
                <td class="details-cell">${detail}</td>
            `;
            tbody.appendChild(tr);
        });
    }

    function renderDocuments(data) {
        const tbody = document.querySelector("#document-table tbody");
        tbody.innerHTML = "";

        if (!data || data.length === 0) {
            const tr = document.createElement("tr");
            tr.innerHTML = '<td colspan="4" class="muted">Keine Dokument-Events gefunden.</td>';
            tbody.appendChild(tr);
            return;
        }

        data.forEach(ev => {
            const p = ev.payload || {};
            const name = p.name || "";
            const path = p.path || "";
            const tr = document.createElement("tr");
            tr.innerHTML = `
                <td><span class="timestamp">${formatTimestamp(ev.timestamp)}</span></td>
                <td>${ev.type}</td>
                <td>${name}</td>
                <td class="path-cell">${path}</td>
            `;
            tbody.appendChild(tr);
        });
    }

    async function loadSettings() {
        const el = document.getElementById("settings-status");
        try {
            const s = await fetchJSON("/settings");
            document.getElementById("retention-input").value = s.screenshot_retention_days;
            el.textContent = "Aktuelle Einstellung geladen.";
        } catch (e) {
            console.error(e);
            el.textContent = "Fehler beim Laden der Einstellungen: " + e.message;
        }
    }

    async function saveSettings() {
        const el = document.getElementById("settings-status");
        const input = document.getElementById("retention-input");
        let days = parseInt(input.value, 10);
        if (isNaN(days) || days < 1) {
            days = 1;
            input.value = "1";
        }
        try {
            const res = await fetch("/settings", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ screenshot_retention_days: days })
            });
            if (!res.ok) throw new Error("HTTP " + res.status);
            const data = await res.json();
            input.value = data.screenshot_retention_days;
            el.textContent = "Gespeichert. Neue Aufbewahrungsdauer: " + data.screenshot_retention_days + " Tage";
        } catch (e) {
            console.error(e);
            el.textContent = "Fehler beim Speichern: " + e.message;
        }
    }

    async function loadData() {
        const statusEl = document.getElementById("status");

        loadSettings();

        try {
            statusEl.textContent = "Lade Top-Fensterâ€¦";
            const top = await fetchJSON("/analysis/top-windows?limit=10");
            renderTopWindows(top);

            statusEl.textContent = "Lade Timelineâ€¦";
            const timeline = await fetchJSON("/analysis/timeline?limit=200");
            renderTimeline(timeline);

            statusEl.textContent = "Lade Routinenâ€¦";
            const routines = await fetchJSON("/analysis/routines?n=3&min_count=3&days=3&limit=10");
            renderRoutines(routines);

            statusEl.textContent = "Lade Automatisierungskandidatenâ€¦";
            const automation = await fetchJSON("/analysis/automation-candidates?days=7&limit=10&hourly_rate=60&automation_factor=0.7");
            renderAutomation(automation);

            statusEl.textContent = "Lade Input-AktivitÃ¤tenâ€¦";
            const inputData = await fetchJSON("/analysis/timeline?source=input&limit=200");
            renderInput(inputData);

            statusEl.textContent = "Lade Dokument-AktivitÃ¤tenâ€¦";
            const docData = await fetchJSON("/analysis/timeline?source=document&limit=100");
            renderDocuments(docData);

            statusEl.textContent = "Letzte Aktualisierung: " + new Date().toLocaleTimeString();
        } catch (e) {
            console.error(e);
            statusEl.textContent = "Fehler beim Laden der Daten: " + e.message;
        }
    }

    document.addEventListener("DOMContentLoaded", () => {
        initTheme();

        const themeBtn = document.getElementById("theme-toggle");
        if (themeBtn) {
            themeBtn.addEventListener("click", () => {
                const current = document.documentElement.getAttribute("data-theme") || "dark";
                const next = current === "dark" ? "light" : "dark";
                applyTheme(next);
            });
        }

        const saveBtn = document.getElementById("save-settings-btn");
        if (saveBtn) {
            saveBtn.addEventListener("click", saveSettings);
        }

        loadData();
        setInterval(loadData, 30000);
    });
</script>
</body>
</html>
