<!DOCTYPE html>
<html lang="de" data-theme="dark">
<head>
    <meta charset="utf-8" />
    <title>Local Activity Tracker</title>
    <style>
        :root {
            --bg-body: #0f172a;
            --bg-header: linear-gradient(120deg, #020617 0%, #0f172a 40%, #0b1120 100%);
            --bg-card: #0b1120;
            --bg-card-inner: #020617;
            --bg-card-soft: #020617;
            --border-subtle: #1e293b;
            --accent: #38bdf8;
            --accent-soft: rgba(56, 189, 248, 0.12);
            --accent-strong: #0ea5e9;
            --text-main: #e5e7eb;
            --text-muted: #9ca3af;
            --text-soft: #6b7280;
            --danger: #f97373;
            --radius-xl: 18px;
            --radius-lg: 12px;
            --shadow-soft: 0 18px 40px rgba(15, 23, 42, 0.7);
        }

        /* Light Theme Overrides */
        html[data-theme="light"] {
            color-scheme: light;
            --bg-body: #f3f4f6;
            --bg-header: linear-gradient(120deg, #eef2ff 0%, #e5e7eb 40%, #e5f3ff 100%);
            --bg-card: #ffffff;
            --bg-card-inner: #ffffff;
            --bg-card-soft: #f9fafb;
            --border-subtle: #e5e7eb;
            --accent: #0284c7;
            --accent-soft: rgba(2, 132, 199, 0.12);
            --accent-strong: #0369a1;
            --text-main: #0f172a;
            --text-muted: #4b5563;
            --text-soft: #9ca3af;
            --shadow-soft: 0 18px 40px rgba(15, 23, 42, 0.15);
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            background: radial-gradient(circle at top left, #1e293b 0, #020617 40%, #000 100%);
            color: var(--text-main);
        }

        html[data-theme="light"] body {
            background: radial-gradient(circle at top left, #e5e7eb 0, #f3f4f6 40%, #e5e7eb 100%);
        }

        .app-shell {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .app-header {
            padding: 16px 24px 10px 24px;
            background: var(--bg-header);
            border-bottom: 1px solid rgba(148, 163, 184, 0.18);
            box-shadow: 0 14px 40px rgba(15, 23, 42, 0.85);
            position: sticky;
            top: 0;
            z-index: 20;
        }

        html[data-theme="light"] .app-header {
            box-shadow: 0 12px 30px rgba(15, 23, 42, 0.12);
            border-bottom-color: rgba(148, 163, 184, 0.35);
        }

        .app-header-main {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 16px;
        }

        .app-title {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .app-title h1 {
            font-size: 22px;
            font-weight: 600;
            letter-spacing: 0.02em;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .app-title h1 span.logo-dot {
            display: inline-flex;
            width: 12px;
            height: 12px;
            border-radius: 999px;
            background: radial-gradient(circle at 30% 30%, #e5f9ff 0, #38bdf8 35%, #0ea5e9 100%);
            box-shadow: 0 0 0 3px rgba(56, 189, 248, 0.35);
        }

        html[data-theme="light"] .app-title h1 span.logo-dot {
            box-shadow: 0 0 0 3px rgba(56, 189, 248, 0.3);
        }

        .app-title small {
            margin: 0;
            color: var(--text-soft);
            font-size: 12px;
        }

        .header-status {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 12px;
        }

        .status-pill {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            border-radius: 999px;
            background: rgba(15, 118, 110, 0.16);
            color: #6ee7b7;
            font-weight: 500;
        }

        html[data-theme="light"] .status-pill {
            background: rgba(34, 197, 94, 0.08);
            color: #059669;
        }

        .status-pill-dot {
            width: 8px;
            height: 8px;
            border-radius: 999px;
            background: #22c55e;
            box-shadow: 0 0 0 4px rgba(34, 197, 94, 0.18);
        }

        #status {
            color: var(--text-muted);
        }

        .theme-toggle-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 30px;
            height: 30px;
            border-radius: 999px;
            border: 1px solid rgba(148, 163, 184, 0.45);
            background: radial-gradient(circle at top left, rgba(15, 23, 42, 0.8) 0, rgba(15, 23, 42, 0.95) 40%, rgba(15, 23, 42, 1) 100%);
            color: #e5e7eb;
            cursor: pointer;
        }

        html[data-theme="light"] .theme-toggle-btn {
            background: radial-gradient(circle at top left, #f9fafb 0, #e5e7eb 50%, #e5e7eb 100%);
            color: #111827;
        }

        .theme-toggle-btn:hover {
            border-color: rgba(248, 250, 252, 0.8);
        }

        .theme-toggle-icon {
            font-size: 15px;
        }

        /* Navigation */
        .app-nav {
            margin-top: 12px;
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }

        .nav-link {
            border: 1px solid transparent;
            background: transparent;
            color: rgba(226, 232, 240, 0.8);
            font-size: 13px;
            padding: 6px 12px;
            border-radius: 999px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .nav-link span.dot {
            width: 6px;
            height: 6px;
            border-radius: 999px;
            background: transparent;
        }

        .nav-link.active {
            background: var(--accent-soft);
            border-color: rgba(56, 189, 248, 0.8);
            color: var(--accent-strong);
        }

        .nav-link.active span.dot {
            background: var(--accent);
        }

        .nav-link:hover:not(.active) {
            background: rgba(15, 23, 42, 0.25);
        }

        html[data-theme="light"] .nav-link:hover:not(.active) {
            background: rgba(243, 244, 246, 0.8);
        }

        .app-main {
            padding: 18px 24px 24px 24px;
        }

        .grid-layout {
            display: grid;
            grid-template-columns: minmax(0, 1.4fr) minmax(0, 1.6fr);
            gap: 18px;
            align-items: flex-start;
        }

        @media (max-width: 1100px) {
            .grid-layout {
                grid-template-columns: minmax(0, 1fr);
            }
        }

        .card {
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-soft);
            padding: 14px 16px 14px 16px;
        }

        .card-inner {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 1rem;
        }

        .card-header h2 {
            margin: 0;
            font-size: 15px;
            font-weight: 600;
            letter-spacing: 0.02em;
        }

        .card-header small {
            display: block;
            margin-top: 2px;
            font-size: 11px;
            color: var(--text-soft);
        }

        .card-tag {
            font-size: 11px;
            padding: 4px 8px;
            border-radius: 999px;
            background: rgba(15, 23, 42, 0.8);
            border: 1px solid rgba(148, 163, 184, 0.4);
            color: var(--text-muted);
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        html[data-theme="light"] .card-tag {
            background: rgba(249, 250, 251, 0.9);
            border-color: rgba(156, 163, 175, 0.7);
        }

        .card-tag span {
            font-weight: 500;
            color: var(--accent);
        }

        .table-container {
            margin-top: 4px;
        }

        .table-scroll {
            max-height: 260px;
            overflow-y: auto;
            border-radius: var(--radius-lg);
            border: 1px solid rgba(30, 64, 175, 0.28);
            background: radial-gradient(circle at top left, rgba(15, 23, 42, 0.92) 0, rgba(15, 23, 42, 0.98) 40%, #020617 100%);
        }

        html[data-theme="light"] .table-scroll {
            background: #ffffff;
            border-color: rgba(209, 213, 219, 0.9);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }

        thead tr {
            background: rgba(15, 23, 42, 0.9);
        }

        html[data-theme="light"] thead tr {
            background: rgba(243, 244, 246, 0.9);
        }

        th, td {
            padding: 6px 10px;
            text-align: left;
        }

        th {
            font-size: 11px;
            font-weight: 600;
            color: var(--text-soft);
            border-bottom: 1px solid rgba(148, 163, 184, 0.3);
            position: sticky;
            top: 0;
            backdrop-filter: blur(6px);
        }

        html[data-theme="light"] th {
            border-bottom-color: rgba(209, 213, 219, 0.9);
        }

        td {
            border-bottom: 1px solid rgba(30, 41, 59, 0.75);
        }

        html[data-theme="light"] td {
            border-bottom-color: rgba(229, 231, 235, 0.9);
        }

        tr:last-child td {
            border-bottom: none;
        }

        .muted {
            color: var(--text-muted);
            font-size: 11px;
        }

        .timestamp {
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
            font-size: 11px;
        }

        .source-pill {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 2px 8px;
            border-radius: 999px;
            font-size: 11px;
            border: 1px solid rgba(148, 163, 184, 0.5);
            text-transform: lowercase;
        }

        .source-pill[data-source="window"] {
            border-color: rgba(59, 130, 246, 0.7);
            color: #93c5fd;
        }

        .source-pill[data-source="input"] {
            border-color: rgba(249, 115, 22, 0.7);
            color: #fdba74;
        }

        .source-pill[data-source="document"] {
            border-color: rgba(132, 204, 22, 0.7);
            color: #bef264;
        }

        .source-pill[data-source="browser"] {
            border-color: rgba(56, 189, 248, 0.7);
            color: #7dd3fc;
        }

        .details-cell {
            font-size: 11px;
            color: var(--text-muted);
        }

        /* Settings */
        .settings-row {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
            font-size: 12px;
        }

        .settings-row label {
            flex: 0 0 210px;
            color: var(--text-muted);
        }

        .settings-row input[type="number"],
        .settings-row input[type="date"],
        .settings-row select {
            flex: 1;
            padding: 5px 7px;
            border-radius: 8px;
            border: 1px solid rgba(148, 163, 184, 0.6);
            background: var(--bg-card-inner);
            color: var(--text-main);
            font-size: 12px;
        }

        html[data-theme="light"] .settings-row input[type="number"],
        html[data-theme="light"] .settings-row input[type="date"],
        html[data-theme="light"] .settings-row select {
            background: #f9fafb;
            border-color: rgba(209, 213, 219, 0.9);
        }

        .settings-row button {
            padding: 6px 10px;
            border-radius: 999px;
            border: 1px solid rgba(56, 189, 248, 0.5);
            background: radial-gradient(circle at top left, rgba(56, 189, 248, 0.15) 0, rgba(56, 189, 248, 0.05) 50%, transparent 100%);
            color: var(--accent-strong);
            font-size: 12px;
            cursor: pointer;
        }

        .settings-row button:hover {
            border-color: rgba(56, 189, 248, 0.9);
        }

        #settings-status {
            font-size: 11px;
            color: var(--text-soft);
            margin-top: 6px;
        }

        .settings-divider {
            margin: 14px 0 8px 0;
            border-top: 1px solid rgba(148, 163, 184, 0.25);
        }

        #export-status {
            font-size: 11px;
            color: var(--text-soft);
            margin-top: 4px;
        }

        /* Date-Range / Filter-Leiste */
        .filter-bar {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
            margin-bottom: 12px;
        }

        .filter-presets {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .filter-btn {
            padding: 5px 10px;
            border-radius: 999px;
            border: 1px solid rgba(148, 163, 184, 0.5);
            background: rgba(15, 23, 42, 0.8);
            color: var(--text-muted);
            font-size: 11px;
            cursor: pointer;
        }

        .filter-btn.active {
            border-color: rgba(56, 189, 248, 0.9);
            background: var(--accent-soft);
            color: var(--accent-strong);
        }

        html[data-theme="light"] .filter-btn {
            background: rgba(249, 250, 251, 0.9);
        }

        .filter-custom {
            display: flex;
            align-items: center;
            gap: 6px;
            flex-wrap: wrap;
        }

        .filter-custom input[type="date"] {
            padding: 4px 6px;
            font-size: 11px;
            border-radius: 8px;
            border: 1px solid rgba(148, 163, 184, 0.6);
            background: var(--bg-card-inner);
            color: var(--text-main);
        }

        html[data-theme="light"] .filter-custom input[type="date"] {
            background: #f9fafb;
            border-color: rgba(209, 213, 219, 0.9);
        }

        .filter-apply {
            padding: 4px 8px;
            border-radius: 999px;
            border: 1px solid rgba(56, 189, 248, 0.7);
            background: rgba(56, 189, 248, 0.12);
            color: var(--accent-strong);
            font-size: 11px;
            cursor: pointer;
        }

        .filter-summary {
            font-size: 11px;
            color: var(--text-soft);
        }

        /* KPI / Tiles */
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 10px;
            margin-bottom: 10px;
        }

        .kpi-card {
            background: var(--bg-card-inner);
            border-radius: var(--radius-lg);
            padding: 10px 12px;
            border: 1px solid rgba(148, 163, 184, 0.4);
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .kpi-label {
            font-size: 11px;
            color: var(--text-soft);
        }

        .kpi-value {
            font-size: 16px;
            font-weight: 600;
        }

        .kpi-sub {
            font-size: 11px;
            color: var(--text-muted);
        }

        /* Pages */
        .page {
            display: none;
        }

        .page.active {
            display: block;
        }

        /* Browser Collector Timeline */
        .timeline-list {
            margin-top: 0.5rem;
            border-radius: 0.75rem;
            background: var(--bg-card-inner);
            border: 1px solid var(--border-subtle);
            padding: 0.5rem 0.75rem;
        }

        .browser-timeline {
            max-height: 260px;
            overflow-y: auto;
        }

        .timeline-item {
            display: grid;
            grid-template-columns: auto 1fr;
            column-gap: 0.75rem;
            row-gap: 0.1rem;
            padding: 0.35rem 0;
            font-size: 0.8rem;
        }

        .timeline-item + .timeline-item {
            border-top: 1px solid rgba(148, 163, 184, 0.25);
        }

        .timeline-item-time {
            font-variant-numeric: tabular-nums;
            color: var(--text-soft);
        }

        .timeline-item-main {
            color: var(--text-main);
        }

        .timeline-item-url {
            font-size: 0.75rem;
            color: var(--text-muted);
            word-break: break-all;
        }

        .timeline-item-tag {
            font-size: 0.7rem;
            padding: 0.05rem 0.4rem;
            border-radius: 999px;
            border: 1px solid var(--border-subtle);
            margin-right: 0.3rem;
        }

        .collector-status-pill {
            padding: 0.25rem 0.75rem;
            border-radius: 999px;
            font-size: 0.75rem;
            font-weight: 500;
            border: 1px solid transparent;
        }

        .status-ok {
            background: rgba(34, 197, 94, 0.12);
            border-color: rgba(34, 197, 94, 0.6);
            color: #4ade80;
        }

        .status-warn {
            background: rgba(234, 179, 8, 0.12);
            border-color: rgba(234, 179, 8, 0.6);
            color: #facc15;
        }

        .status-offline {
            background: rgba(239, 68, 68, 0.12);
            border-color: rgba(239, 68, 68, 0.6);
            color: #f97373;
        }

        .status-meta {
            display: flex;
            justify-content: space-between;
            font-size: 0.8rem;
            color: var(--text-soft);
        }

        .timeline-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .timeline-count {
            font-size: 0.75rem;
        }

        /* SpaltengrÃ¶ÃŸen fÃ¼r bessere Lesbarkeit */
        #timeline-table th:nth-child(1),
        #timeline-table td:nth-child(1),
        #input-table th:nth-child(1),
        #input-table td:nth-child(1),
        #document-table th:nth-child(1),
        #document-table td:nth-child(1) {
            width: 160px;
        }

        #timeline-table th:nth-child(2),
        #timeline-table td:nth-child(2) {
            width: 90px;
        }

        #timeline-table th:nth-child(3),
        #timeline-table td:nth-child(3),
        #input-table th:nth-child(2),
        #input-table td:nth-child(2),
        #document-table th:nth-child(2),
        #document-table td:nth-child(2) {
            width: 120px;
        }
    </style>
</head>
<body>
<div class="app-shell">
    <header class="app-header">
        <div class="app-header-main">
            <div class="app-title">
                <h1>
                    <span class="logo-dot"></span>
                    Local Activity Tracker
                </h1>
                <small id="status">Lade Datenâ€¦</small>
            </div>
            <div class="header-status">
                <div class="status-pill">
                    <span class="status-pill-dot"></span>
                    <span>Erfassung aktiv</span>
                </div>
                <button id="theme-toggle" class="theme-toggle-btn" title="Theme umschalten">
                    <span class="theme-toggle-icon">ðŸŒ™</span>
                </button>
            </div>
        </div>

        <nav class="app-nav">
            <button class="nav-link active" data-target="dashboard">
                <span class="dot"></span>Dashboard
            </button>
            <button class="nav-link" data-target="windows">
                <span class="dot"></span>Fenster
            </button>
            <button class="nav-link" data-target="input">
                <span class="dot"></span>Input
            </button>
            <button class="nav-link" data-target="documents">
                <span class="dot"></span>Dokumente
            </button>
            <button class="nav-link" data-target="screenshots">
                <span class="dot"></span>Screenshots
            </button>
            <button class="nav-link" data-target="browser">
                <span class="dot"></span>Browser
            </button>
            <button class="nav-link" data-target="settings">
                <span class="dot"></span>Settings
            </button>
        </nav>
    </header>

    <main class="app-main">
        <!-- DASHBOARD -->
        <section id="page-dashboard" class="page active">
            <div class="filter-bar" data-page="dashboard">
                <div class="filter-presets">
                    <button class="filter-btn active" data-page="dashboard" data-preset="today">Heute</button>
                    <button class="filter-btn" data-page="dashboard" data-preset="week">Woche</button>
                    <button class="filter-btn" data-page="dashboard" data-preset="month">Monat</button>
                    <button class="filter-btn" data-page="dashboard" data-preset="quarter">Quartal</button>
                    <button class="filter-btn" data-page="dashboard" data-preset="year">Jahr</button>
                    <button class="filter-btn" data-page="dashboard" data-preset="custom">Benutzerdefiniert</button>
                </div>
                <div class="filter-custom">
                    <input type="date" id="filter-from-dashboard">
                    <span style="font-size:11px;color:var(--text-soft);">bis</span>
                    <input type="date" id="filter-to-dashboard">
                    <button class="filter-apply" data-page="dashboard">Anwenden</button>
                </div>
                <div class="filter-summary" id="filter-summary-dashboard">
                    Zeitraum: Heute
                </div>
            </div>

            <div class="kpi-grid" id="dashboard-kpis">
                <div class="kpi-card">
                    <div class="kpi-label">Gesamt aktive Fensterzeit</div>
                    <div class="kpi-value" id="kpi-active-time">â€“</div>
                    <div class="kpi-sub">auf Basis Fenster-Fokus</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-label">TastenanschlÃ¤ge</div>
                    <div class="kpi-value" id="kpi-keystrokes">â€“</div>
                    <div class="kpi-sub">im gewÃ¤hlten Zeitraum</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-label">Mausklicks</div>
                    <div class="kpi-value" id="kpi-clicks">â€“</div>
                    <div class="kpi-sub">inkl. Rechts-/Mittelklick</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-label">Dokumenten-Events</div>
                    <div class="kpi-value" id="kpi-doc-events">â€“</div>
                    <div class="kpi-sub">create / modify / delete</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-label">Browser-Events</div>
                    <div class="kpi-value" id="kpi-browser-events">â€“</div>
                    <div class="kpi-sub">Tabs, Page Loads, Inputs</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-label">Screenshots & Coverage</div>
                    <div class="kpi-value" id="kpi-screenshots">â€“</div>
                    <div class="kpi-sub" id="kpi-coverage-sub">Monitoring-Coverage</div>
                </div>
            </div>

            <div class="grid-layout">
                <section class="card">
                    <div class="card-inner">
                        <!-- Top Windows -->
                        <div class="card-header">
                            <div>
                                <h2>Top Fenster / Anwendungen</h2>
                                <small>Basierend auf window_focus-Events</small>
                            </div>
                            <div class="card-tag">
                                Letzte <span>Sessions</span>
                            </div>
                        </div>
                        <div class="table-container">
                            <div class="table-scroll">
                                <table id="top-windows-table">
                                    <thead>
                                    <tr>
                                        <th>App</th>
                                        <th>Titel</th>
                                        <th>Minuten</th>
                                        <th>Stunden</th>
                                    </tr>
                                    </thead>
                                    <tbody>
                                    <tr><td colspan="4" class="muted">Noch keine Datenâ€¦</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Timeline -->
                        <div class="card-header" style="margin-top: 16px;">
                            <div>
                                <h2>Timeline (alle Quellen)</h2>
                                <small>Neueste Events zuerst Â· Limit 200</small>
                            </div>
                            <div class="card-tag">
                                Quelle: <span>Alle</span>
                            </div>
                        </div>
                        <div class="table-container">
                            <div class="table-scroll">
                                <table id="timeline-table">
                                    <thead>
                                    <tr>
                                        <th>Zeit</th>
                                        <th>Quelle</th>
                                        <th>Typ</th>
                                        <th>Details</th>
                                    </tr>
                                    </thead>
                                    <tbody>
                                    <tr><td colspan="4" class="muted">Noch keine Datenâ€¦</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Routinen -->
                        <div class="card-header" style="margin-top: 16px;">
                            <div>
                                <h2>Wiederkehrende Routinen</h2>
                                <small>Erkannte Nutzungsmuster</small>
                            </div>
                            <div class="card-tag">
                                Analyse <span>Task-Mining</span>
                            </div>
                        </div>
                        <div class="table-container">
                            <div class="table-scroll">
                                <table id="routines-table">
                                    <thead>
                                    <tr>
                                        <th>Sequenz</th>
                                        <th>Vorkommen</th>
                                        <th>Stunden</th>
                                    </tr>
                                    </thead>
                                    <tbody>
                                    <tr><td colspan="3" class="muted">Noch keine Routinen gefunden.</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        
                    </div>
                </section>

                <!-- Rechte Spalte: kompakte Ãœbersicht -->
                <section class="card">
                    <div class="card-inner">
                        <div class="card-header">
                            <div>
                                <h2>Letzte AktivitÃ¤ten (kompakt)</h2>
                                <small>Letzte Events Ã¼ber alle Collectoren</small>
                            </div>
                            <div class="card-tag">
                                Fokus <span>Today</span>
                            </div>
                        </div>
                        <div class="table-container">
                            <div class="table-scroll">
                                <table id="dashboard-latest-table">
                                    <thead>
                                    <tr>
                                        <th>Zeit</th>
                                        <th>Quelle</th>
                                        <th>Typ</th>
                                        <th>Details</th>
                                    </tr>
                                    </thead>
                                    <tbody>
                                    <tr><td colspan="4" class="muted">Noch keine Datenâ€¦</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <div class="card-header" style="margin-top:18px;">
                            <div>
                                <h2>Top-Fenster nach Input</h2>
                                <small>Wo findet die meiste Interaktion statt?</small>
                            </div>
                        </div>
                        <div class="table-container">
                            <div class="table-scroll">
                                <table id="dashboard-top-input-windows">
                                    <thead>
                                    <tr>
                                        <th>App</th>
                                        <th>Titel</th>
                                        <th>Input-Events</th>
                                    </tr>
                                    </thead>
                                    <tbody>
                                    <tr><td colspan="3" class="muted">Noch keine Datenâ€¦</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

			<!-- Automatisierung -->
                        <div class="card-header" style="margin-top: 16px;">
                            <div>
                                <h2>Automatisierungskandidaten</h2>
                                <small>Potenzielle Zeit- & Kostenersparnis</small>
                            </div>
                            <div class="card-tag">
                                Fokus <span>Top-Zeitfresser</span>
                            </div>
                        </div>
                        <div class="table-container">
                            <div class="table-scroll">
                                <table id="automation-table">
                                    <thead>
                                    <tr>
                                        <th>App</th>
                                        <th>Titel</th>
                                        <th>Ã˜ Min/Tag</th>
                                        <th>Stunden/Jahr</th>
                                        <th>Pot. Ersparnis/Jahr</th>
                                    </tr>
                                    </thead>
                                    <tbody>
                                    <tr><td colspan="5" class="muted">Noch keine Kandidaten gefunden.</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </section>
            </div>
        </section>

        <!-- FENSTER -->
        <section id="page-windows" class="page">
            <div class="filter-bar" data-page="windows">
                <div class="filter-presets">
                    <button class="filter-btn active" data-page="windows" data-preset="today">Heute</button>
                    <button class="filter-btn" data-page="windows" data-preset="week">Woche</button>
                    <button class="filter-btn" data-page="windows" data-preset="month">Monat</button>
                    <button class="filter-btn" data-page="windows" data-preset="quarter">Quartal</button>
                    <button class="filter-btn" data-page="windows" data-preset="year">Jahr</button>
                    <button class="filter-btn" data-page="windows" data-preset="custom">Benutzerdefiniert</button>
                </div>
                <div class="filter-custom">
                    <input type="date" id="filter-from-windows">
                    <span style="font-size:11px;color:var(--text-soft);">bis</span>
                    <input type="date" id="filter-to-windows">
                    <button class="filter-apply" data-page="windows">Anwenden</button>
                </div>
                <div class="filter-summary" id="filter-summary-windows">
                    Zeitraum: Heute
                </div>
            </div>

            <div class="kpi-grid">
                <div class="kpi-card">
                    <div class="kpi-label">Gesamt aktive Zeit</div>
                    <div class="kpi-value" id="win-kpi-active-time">â€“</div>
                    <div class="kpi-sub">Fenster-Fokuszeit</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-label">Anzahl Anwendungen</div>
                    <div class="kpi-value" id="win-kpi-app-count">â€“</div>
                    <div class="kpi-sub">verschiedene Apps</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-label">Top-App</div>
                    <div class="kpi-value" id="win-kpi-top-app">â€“</div>
                    <div class="kpi-sub">nach Fokuszeit</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-label">Fenster-Wechsel (geschÃ¤tzt)</div>
                    <div class="kpi-value" id="win-kpi-switches">â€“</div>
                    <div class="kpi-sub">aus Timeline abgeleitet</div>
                </div>
            </div>

            <div class="grid-layout">
                <section class="card">
                    <div class="card-inner">
                        <div class="card-header">
                            <div>
                                <h2>Top Fenster / Anwendungen</h2>
                                <small>Aggregiert nach App + Titel</small>
                            </div>
                        </div>
                        <div class="table-container">
                            <div class="table-scroll">
                                <table id="windows-top-table">
                                    <thead>
                                    <tr>
                                        <th>App</th>
                                        <th>Titel</th>
                                        <th>Minuten</th>
                                        <th>Stunden</th>
                                    </tr>
                                    </thead>
                                    <tbody>
                                    <tr><td colspan="4" class="muted">Keine Datenâ€¦</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </section>

                <section class="card">
                    <div class="card-inner">
                        <div class="card-header">
                            <div>
                                <h2>Fenster-Fokus Timeline</h2>
                                <small>Nur source=window</small>
                            </div>
                        </div>
                        <div class="table-container">
                            <div class="table-scroll">
                                <table id="windows-timeline-table">
                                    <thead>
                                    <tr>
                                        <th>Zeit</th>
                                        <th>Quelle</th>
                                        <th>Typ</th>
                                        <th>Details</th>
                                    </tr>
                                    </thead>
                                    <tbody>
                                    <tr><td colspan="4" class="muted">Keine Datenâ€¦</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </section>
            </div>
        </section>

        <!-- INPUT -->
        <section id="page-input" class="page">
            <div class="filter-bar" data-page="input">
                <div class="filter-presets">
                    <button class="filter-btn active" data-page="input" data-preset="today">Heute</button>
                    <button class="filter-btn" data-page="input" data-preset="week">Woche</button>
                    <button class="filter-btn" data-page="input" data-preset="month">Monat</button>
                    <button class="filter-btn" data-page="input" data-preset="quarter">Quartal</button>
                    <button class="filter-btn" data-page="input" data-preset="year">Jahr</button>
                    <button class="filter-btn" data-page="input" data-preset="custom">Benutzerdefiniert</button>
                </div>
                <div class="filter-custom">
                    <input type="date" id="filter-from-input">
                    <span style="font-size:11px;color:var(--text-soft);">bis</span>
                    <input type="date" id="filter-to-input">
                    <button class="filter-apply" data-page="input">Anwenden</button>
                </div>
                <div class="filter-summary" id="filter-summary-input">
                    Zeitraum: Heute
                </div>
            </div>

            <div class="kpi-grid">
                <div class="kpi-card">
                    <div class="kpi-label">Mausklicks</div>
                    <div class="kpi-value" id="input-kpi-clicks">â€“</div>
                    <div class="kpi-sub">alle Buttons</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-label">TastenanschlÃ¤ge</div>
                    <div class="kpi-value" id="input-kpi-keystrokes">â€“</div>
                    <div class="kpi-sub">key_down-Events</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-label">Scroll-Events</div>
                    <div class="kpi-value" id="input-kpi-scrolls">â€“</div>
                    <div class="kpi-sub">Mausrad / Touchpad</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-label">Top-Anwendung</div>
                    <div class="kpi-value" id="input-kpi-top-app">â€“</div>
                    <div class="kpi-sub">nach Input-Events</div>
                </div>
            </div>

            <section class="card">
                <div class="card-inner">
                    <div class="card-header">
                        <div>
                            <h2>Input-Events (Detail)</h2>
                            <small>Tastatur- & Maus-Ereignisse</small>
                        </div>
                        <div class="card-tag">
                            Quelle: <span>input</span>
                        </div>
                    </div>
                    <div class="table-container">
                        <div class="table-scroll">
                            <table id="input-table">
                                <thead>
                                <tr>
                                    <th>Zeit</th>
                                    <th>Typ</th>
                                    <th>App/Titel</th>
                                    <th>Details</th>
                                </tr>
                                </thead>
                                <tbody>
                                <tr><td colspan="4" class="muted">Keine Input-Daten gefunden.</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>
        </section>

        <!-- DOKUMENTE -->
        <section id="page-documents" class="page">
            <div class="filter-bar" data-page="documents">
                <div class="filter-presets">
                    <button class="filter-btn active" data-page="documents" data-preset="today">Heute</button>
                    <button class="filter-btn" data-page="documents" data-preset="week">Woche</button>
                    <button class="filter-btn" data-page="documents" data-preset="month">Monat</button>
                    <button class="filter-btn" data-page="documents" data-preset="quarter">Quartal</button>
                    <button class="filter-btn" data-page="documents" data-preset="year">Jahr</button>
                    <button class="filter-btn" data-page="documents" data-preset="custom">Benutzerdefiniert</button>
                </div>
                <div class="filter-custom">
                    <input type="date" id="filter-from-documents">
                    <span style="font-size:11px;color:var(--text-soft);">bis</span>
                    <input type="date" id="filter-to-documents">
                    <button class="filter-apply" data-page="documents">Anwenden</button>
                </div>
                <div class="filter-summary" id="filter-summary-documents">
                    Zeitraum: Heute
                </div>
            </div>

            <div class="kpi-grid">
                <div class="kpi-card">
                    <div class="kpi-label">GeÃ¤nderte Dateien</div>
                    <div class="kpi-value" id="doc-kpi-total">â€“</div>
                    <div class="kpi-sub">alle Datei-Events</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-label">Neu erstellt</div>
                    <div class="kpi-value" id="doc-kpi-created">â€“</div>
                    <div class="kpi-sub">create-Events</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-label">GelÃ¶scht</div>
                    <div class="kpi-value" id="doc-kpi-deleted">â€“</div>
                    <div class="kpi-sub">delete-Events</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-label">HÃ¤ufigster Dateityp</div>
                    <div class="kpi-value" id="doc-kpi-top-ext">â€“</div>
                    <div class="kpi-sub">aus Pfaden ermittelt</div>
                </div>
            </div>

            <section class="card">
                <div class="card-inner">
                    <div class="card-header">
                        <div>
                            <h2>Dokumenten-AktivitÃ¤ten</h2>
                            <small>DateiÃ¤nderungen & -zugriffe</small>
                        </div>
                        <div class="card-tag">
                            Quelle: <span>document</span>
                        </div>
                    </div>
                    <div class="table-container">
                        <div class="table-scroll">
                            <table id="document-table">
                                <thead>
                                <tr>
                                    <th>Zeit</th>
                                    <th>Typ</th>
                                    <th>Pfad</th>
                                    <th>Details</th>
                                </tr>
                                </thead>
                                <tbody>
                                <tr><td colspan="4" class="muted">Keine Dokument-Events gefunden.</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>
        </section>

        <!-- SCREENSHOTS -->
        <section id="page-screenshots" class="page">
            <div class="filter-bar" data-page="screenshots">
                <div class="filter-presets">
                    <button class="filter-btn active" data-page="screenshots" data-preset="today">Heute</button>
                    <button class="filter-btn" data-page="screenshots" data-preset="week">Woche</button>
                    <button class="filter-btn" data-page="screenshots" data-preset="month">Monat</button>
                    <button class="filter-btn" data-page="screenshots" data-preset="quarter">Quartal</button>
                    <button class="filter-btn" data-page="screenshots" data-preset="year">Jahr</button>
                    <button class="filter-btn" data-page="screenshots" data-preset="custom">Benutzerdefiniert</button>
                </div>
                <div class="filter-custom">
                    <input type="date" id="filter-from-screenshots">
                    <span style="font-size:11px;color:var(--text-soft);">bis</span>
                    <input type="date" id="filter-to-screenshots">
                    <button class="filter-apply" data-page="screenshots">Anwenden</button>
                </div>
                <div class="filter-summary" id="filter-summary-screenshots">
                    Zeitraum: Heute
                </div>
            </div>

            <div class="kpi-grid">
                <div class="kpi-card">
                    <div class="kpi-label">Anzahl Screenshots</div>
                    <div class="kpi-value" id="ss-kpi-count">â€“</div>
                    <div class="kpi-sub">im Zeitraum</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-label">Ã˜ Aufnahmeintervall</div>
                    <div class="kpi-value" id="ss-kpi-interval">â€“</div>
                    <div class="kpi-sub">Sekunden</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-label">GesamtgrÃ¶ÃŸe</div>
                    <div class="kpi-value" id="ss-kpi-size">â€“</div>
                    <div class="kpi-sub">im Zeitraum</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-label">Abgedeckte Zeit</div>
                    <div class="kpi-value" id="ss-kpi-coverage">â€“</div>
                    <div class="kpi-sub">Monitoring-Coverage</div>
                </div>
            </div>

            <section class="card">
                <div class="card-inner">
                    <div class="card-header">
                        <div>
                            <h2>Screenshot-Liste</h2>
                            <small>Metadaten pro Screenshot</small>
                        </div>
                    </div>
                    <div class="table-container">
                        <div class="table-scroll">
                            <table id="screenshot-table">
                                <thead>
                                <tr>
                                    <th>Zeit</th>
                                    <th>Dateiname</th>
                                    <th>Pfad</th>
                                    <th>GrÃ¶ÃŸe</th>
                                </tr>
                                </thead>
                                <tbody>
                                <tr><td colspan="4" class="muted">Noch keine Screenshots im Zeitraum.</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>
        </section>

        <!-- BROWSER -->
        <section id="page-browser" class="page">
            <div class="filter-bar" data-page="browser">
                <div class="filter-presets">
                    <button class="filter-btn active" data-page="browser" data-preset="today">Heute</button>
                    <button class="filter-btn" data-page="browser" data-preset="week">Woche</button>
                    <button class="filter-btn" data-page="browser" data-preset="month">Monat</button>
                    <button class="filter-btn" data-page="browser" data-preset="quarter">Quartal</button>
                    <button class="filter-btn" data-page="browser" data-preset="year">Jahr</button>
                    <button class="filter-btn" data-page="browser" data-preset="custom">Benutzerdefiniert</button>
                </div>
                <div class="filter-custom">
                    <input type="date" id="filter-from-browser">
                    <span style="font-size:11px;color:var(--text-soft);">bis</span>
                    <input type="date" id="filter-to-browser">
                    <button class="filter-apply" data-page="browser">Anwenden</button>
                </div>
                <div class="filter-summary" id="filter-summary-browser">
                    Zeitraum: Heute
                </div>
            </div>

            <div class="kpi-grid">
                <div class="kpi-card">
                    <div class="kpi-label">GeÃ¶ffnete Tabs</div>
                    <div class="kpi-value" id="br-kpi-tabs">â€“</div>
                    <div class="kpi-sub">im Zeitraum</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-label">Page Loads</div>
                    <div class="kpi-value" id="br-kpi-page-loads">â€“</div>
                    <div class="kpi-sub">page_loaded-Events</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-label">Browser-Klicks</div>
                    <div class="kpi-value" id="br-kpi-clicks">â€“</div>
                    <div class="kpi-sub">DOM click-Events</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-label">Domains</div>
                    <div class="kpi-value" id="br-kpi-domains">â€“</div>
                    <div class="kpi-sub">verschiedene Domains</div>
                </div>
            </div>

            <section class="card">
                <div class="card-inner">
                    <div class="card-header">
                        <div>
                            <h2>Browser Collector</h2>
                            <small>Status & letzte AktivitÃ¤ten</small>
                        </div>
                        <div id="browser-status-pill" class="collector-status-pill status-offline">
                            Offline
                        </div>
                    </div>

                    <div class="card-body">
                        <div class="status-meta">
                            <span>Letztes Event: <span id="browser-last-event">â€“</span></span>
                            <span>Seitdem: <span id="browser-last-diff">â€“</span></span>
                        </div>

                        <div class="timeline-header" style="margin-top:8px;">
                            <span>Letzte Browser-Ereignisse</span>
                            <span id="browser-event-count" class="timeline-count">0 EintrÃ¤ge</span>
                        </div>

                        <div id="browser-timeline" class="timeline-list browser-timeline"></div>
                    </div>
                </div>
            </section>
        </section>

        <!-- SETTINGS -->
        <section id="page-settings" class="page">
            <section class="card">
                <div class="card-inner">
                    <div class="card-header">
                        <div>
                            <h2>Einstellungen</h2>
                            <small>Aufbewahrung & Export</small>
                        </div>
                        <div class="card-tag">
                            Screenshots <span>WebP</span>
                        </div>
                    </div>
                    <div>
                        <div class="settings-row">
                            <label for="retention-input">Screenshots behalten fÃ¼r (Tage):</label>
                            <input id="retention-input" type="number" min="1" max="365" value="7" />
                            <button id="save-settings-btn">Speichern</button>
                        </div>
                        <div id="settings-status"></div>

                        <div class="settings-divider"></div>

                        <div class="settings-row">
                            <label>Export Zeitraum:</label>
                            <div style="display:flex;gap:6px;flex-wrap:wrap;">
                                <input id="date-from" type="date" />
                                <span style="font-size:11px;color:var(--text-soft);">bis</span>
                                <input id="date-to" type="date" />
                            </div>
                        </div>
                        <div class="settings-row">
                            <label for="source-filter">Quelle:</label>
                            <select id="source-filter">
                                <option value="">Alle</option>
                                <option value="window">window</option>
                                <option value="input">input</option>
                                <option value="document">document</option>
                                <option value="browser">browser</option>
                            </select>
                            <button id="export-button">Export starten</button>
                        </div>
                        <div id="export-status"></div>
                    </div>
                </div>
            </section>
        </section>
    </main>
</div>

<script>
    // --- Theme-Handling ---
    function applyTheme(theme) {
        const html = document.documentElement;
        const btnIcon = document.querySelector(".theme-toggle-icon");
        html.setAttribute("data-theme", theme);
        localStorage.setItem("lat-theme", theme);
        if (btnIcon) {
            btnIcon.textContent = theme === "light" ? "â˜€" : "ðŸŒ™";
        }
    }

    function initTheme() {
        const saved = localStorage.getItem("lat-theme");
        const prefersDark = window.matchMedia && window.matchMedia("(prefers-color-scheme: dark)").matches;
        let theme = "dark";

        if (saved === "dark" || saved === "light") {
            theme = saved;
        } else {
            theme = prefersDark ? "dark" : "light";
        }
        applyTheme(theme);
    }

    // --- Helpers ---
    async function fetchJSON(url) {
        const res = await fetch(url);
        if (!res.ok) throw new Error("HTTP " + res.status);
        return res.json();
    }

    function formatTimestamp(ts) {
        try {
            const d = new Date(ts);
            return d.toLocaleString("de-DE");
        } catch {
            return ts;
        }
    }

    function shortPayload(payload) {
        if (!payload) return "";
        if (payload.app || payload.title) {
            return [payload.app, payload.title].filter(Boolean).join(" â€“ ");
        }
        if (payload.path) {
            return payload.path;
        }
        if (payload.key) {
            return "Key: " + payload.key;
        }
        if (payload.button) {
            return "Mouse " + payload.button + " @ (" + payload.x + "," + payload.y + ")";
        }
        return JSON.stringify(payload).slice(0, 80) + (JSON.stringify(payload).length > 80 ? "â€¦" : "");
    }

    // --- Renderer generisch ---
    function renderTopWindows(data, tableId) {
        const tbody = document.querySelector("#" + tableId + " tbody");
        if (!tbody) return;
        tbody.innerHTML = "";

        if (!data || data.length === 0) {
            const tr = document.createElement("tr");
            tr.innerHTML = '<td colspan="4" class="muted">Keine Daten verfÃ¼gbar.</td>';
            tbody.appendChild(tr);
            return;
        }

        data.forEach(row => {
            const tr = document.createElement("tr");
            const app = row.app || "(unbekannt)";
            const title = row.title || "";
            const minutes = typeof row.total_minutes === "number" ? row.total_minutes.toFixed(1) : "â€“";
            const hours = typeof row.total_hours === "number" ? row.total_hours.toFixed(2) : "â€“";
            tr.innerHTML = `
                <td>${app}</td>
                <td>${title}</td>
                <td>${minutes}</td>
                <td>${hours}</td>
            `;
            tbody.appendChild(tr);
        });
    }

    function renderTimeline(data, tableId, sourceOverride) {
        const tbody = document.querySelector("#" + tableId + " tbody");
        if (!tbody) return;
        tbody.innerHTML = "";

        if (!data || data.length === 0) {
            const tr = document.createElement("tr");
            tr.innerHTML = '<td colspan="4" class="muted">Keine Daten verfÃ¼gbar.</td>';
            tbody.appendChild(tr);
            return;
        }

        data.forEach(ev => {
            const tr = document.createElement("tr");
            const source = sourceOverride || ev.source;
            tr.innerHTML = `
                <td><span class="timestamp">${formatTimestamp(ev.timestamp)}</span></td>
                <td><span class="source-pill" data-source="${source}">${source}</span></td>
                <td>${ev.type}</td>
                <td class="details-cell">${shortPayload(ev.payload)}</td>
            `;
            tbody.appendChild(tr);
        });
    }

    function renderRoutines(data, tableId) {
        const tbody = document.querySelector("#" + tableId + " tbody");
        if (!tbody) return;
        tbody.innerHTML = "";

        if (!data || data.length === 0) {
            const tr = document.createElement("tr");
            tr.innerHTML = '<td colspan="3" class="muted">Noch keine Routinen gefunden.</td>';
            tbody.appendChild(tr);
            return;
        }

        data.forEach(r => {
            const tr = document.createElement("tr");
            const seqText = (r.sequence || [])
                .map(s => (s.app || "??") + " â€“ " + (s.title || ""))
                .join("  â†’  ");
            tr.innerHTML = `
                <td>${seqText}</td>
                <td>${r.count}</td>
                <td>${(r.total_hours || 0).toFixed(2)}</td>
            `;
            tbody.appendChild(tr);
        });
    }

    function renderAutomation(data, tableId) {
        const tbody = document.querySelector("#" + tableId + " tbody");
        if (!tbody) return;
        tbody.innerHTML = "";

        if (!data || data.length === 0) {
            const tr = document.createElement("tr");
            tr.innerHTML = '<td colspan="5" class="muted">Noch keine Kandidaten gefunden.</td>';
            tbody.appendChild(tr);
            return;
        }

        data.forEach(c => {
            const tr = document.createElement("tr");
            tr.innerHTML = `
                <td>${c.app || "??"}</td>
                <td>${c.title || ""}</td>
                <td>${(c.avg_minutes_per_day || 0).toFixed(1)}</td>
                <td>${(c.yearly_hours || 0).toFixed(1)}</td>
                <td>${(c.potential_savings_per_year || 0).toFixed(0)}</td>
            `;
            tbody.appendChild(tr);
        });
    }

    function renderInput(data, tableId) {
        const tbody = document.querySelector("#" + tableId + " tbody");
        if (!tbody) return;
        tbody.innerHTML = "";

        if (!data || data.length === 0) {
            const tr = document.createElement("tr");
            tr.innerHTML = '<td colspan="4" class="muted">Keine Input-Daten gefunden.</td>';
            tbody.appendChild(tr);
            return;
        }

        data.forEach(ev => {
            const p = ev.payload || {};
            const appTitle = [p.app, p.title].filter(Boolean).join(" â€“ ");
            let detail = "";
            if (p.key) {
                detail = "Key: " + p.key;
            } else if (p.button) {
                detail = "Mouse " + p.button + " @ (" + p.x + "," + p.y + ")";
            } else if (typeof p.x === "number" && typeof p.y === "number") {
                detail = "Move @ (" + p.x + "," + p.y + ")";
            } else {
                detail = shortPayload(p);
            }

            const tr = document.createElement("tr");
            tr.innerHTML = `
                <td><span class="timestamp">${formatTimestamp(ev.timestamp)}</span></td>
                <td>${ev.type}</td>
                <td>${appTitle}</td>
                <td class="details-cell">${detail}</td>
            `;
            tbody.appendChild(tr);
        });
    }

    function renderDocuments(data, tableId) {
        const tbody = document.querySelector("#" + tableId + " tbody");
        if (!tbody) return;
        tbody.innerHTML = "";

        if (!data || data.length === 0) {
            const tr = document.createElement("tr");
            tr.innerHTML = '<td colspan="4" class="muted">Keine Dokument-Events gefunden.</td>';
            tbody.appendChild(tr);
            return;
        }

        data.forEach(ev => {
            const p = ev.payload || {};
            const path = p.path || "(kein Pfad)";
            const detail = shortPayload(p);

            const tr = document.createElement("tr");
            tr.innerHTML = `
                <td><span class="timestamp">${formatTimestamp(ev.timestamp)}</span></td>
                <td>${ev.type}</td>
                <td>${path}</td>
                <td class="details-cell">${detail}</td>
            `;
            tbody.appendChild(tr);
        });
    }

    function renderScreenshots(data) {
        const tbody = document.querySelector("#screenshot-table tbody");
        if (!tbody) return;
        tbody.innerHTML = "";

        if (!data || data.length === 0) {
            const tr = document.createElement("tr");
            tr.innerHTML = '<td colspan="4" class="muted">Noch keine Screenshots im Zeitraum.</td>';
            tbody.appendChild(tr);
            return;
        }

        data.forEach(item => {
            const tr = document.createElement("tr");
            const sizeMb = item.size_bytes ? (item.size_bytes / (1024 * 1024)).toFixed(2) + " MB" : "â€“";
            tr.innerHTML = `
                <td><span class="timestamp">${formatTimestamp(item.timestamp)}</span></td>
                <td>${item.filename || ""}</td>
                <td>${item.path || ""}</td>
                <td>${sizeMb}</td>
            `;
            tbody.appendChild(tr);
        });
    }

    // --- Date Range / Filter ---
    const pageState = {};

    function getPresetRange(preset) {
        const now = new Date();
        const end = new Date(now);
        let start = new Date(now);

        function startOfDay(d) {
            return new Date(d.getFullYear(), d.getMonth(), d.getDate(), 0, 0, 0, 0);
        }

        switch (preset) {
            case "today":
                start = startOfDay(now);
                break;
            case "week":
                start = new Date(now);
                start.setDate(start.getDate() - 6);
                start = startOfDay(start);
                break;
            case "month":
                start = new Date(now);
                start.setDate(start.getDate() - 29);
                start = startOfDay(start);
                break;
            case "quarter":
                start = new Date(now);
                start.setDate(start.getDate() - 89);
                start = startOfDay(start);
                break;
            case "year":
                start = new Date(now);
                start.setDate(start.getDate() - 364);
                start = startOfDay(start);
                break;
            default:
                start = startOfDay(now);
        }
        return { from: start, to: end };
    }

    function getCustomRange(page) {
        const fromEl = document.getElementById("filter-from-" + page);
        const toEl = document.getElementById("filter-to-" + page);
        if (!fromEl || !toEl || !fromEl.value || !toEl.value) return null;

        const from = new Date(fromEl.value + "T00:00:00");
        const to = new Date(toEl.value + "T23:59:59");
        if (isNaN(from.getTime()) || isNaN(to.getTime()) || from > to) {
            return null;
        }
        return { from, to };
    }

    function formatRangeLabel(range, presetLabel) {
        if (!range) return "";
        const fromStr = range.from.toLocaleDateString("de-DE");
        const toStr = range.to.toLocaleDateString("de-DE");
        return `Zeitraum: ${fromStr} â€“ ${toStr}` + (presetLabel ? ` (${presetLabel})` : "");
    }

    function updateFilterSummary(page) {
        const state = pageState[page];
        const el = document.getElementById("filter-summary-" + page);
        if (!el || !state || !state.range) return;
        el.textContent = formatRangeLabel(state.range, state.presetLabel);
    }

    function rangeToQuery(range) {
        if (!range) return "";
        const params = new URLSearchParams();
        params.set("from", range.from.toISOString());
        params.set("to", range.to.toISOString());
        return params.toString();
    }

    // --- Page Loader ---
    async function loadDashboard(range) {
        const statusEl = document.getElementById("status");
        try {
            const qs = rangeToQuery(range);
            statusEl.textContent = "Lade Dashboardâ€¦";

            // Optional: Dashboard-Summary (kannst du im Backend nachrÃ¼sten)
            try {
                const summary = await fetchJSON("/analysis/dashboard/summary?" + qs);
                if (summary) {
                    document.getElementById("kpi-active-time").textContent =
                        (summary.total_active_hours || 0).toFixed(1) + " h";
                    document.getElementById("kpi-keystrokes").textContent =
                        summary.total_keystrokes ?? "â€“";
                    document.getElementById("kpi-clicks").textContent =
                        summary.total_clicks ?? "â€“";
                    document.getElementById("kpi-doc-events").textContent =
                        summary.document_events ?? "â€“";
                    document.getElementById("kpi-browser-events").textContent =
                        summary.browser_events ?? "â€“";
                    document.getElementById("kpi-screenshots").textContent =
                        summary.screenshot_count ?? "â€“";
                    document.getElementById("kpi-coverage-sub").textContent =
                        "Coverage: " + (summary.coverage_percent != null ? summary.coverage_percent.toFixed(0) + "%" : "n/a");
                }
            } catch (e) {
                // Wenn Endpoint noch nicht existiert, einfach ignorieren
                console.warn("Dashboard summary not available:", e);
            }

            const top = await fetchJSON("/analysis/top-windows?limit=10&" + qs);
            renderTopWindows(top, "top-windows-table");

            const timeline = await fetchJSON("/analysis/timeline?limit=200&" + qs);
            renderTimeline(timeline, "timeline-table");

            const routines = await fetchJSON("/analysis/routines?limit=10&" + qs);
            renderRoutines(routines, "routines-table");

            const automation = await fetchJSON("/analysis/automation-candidates?limit=10&" + qs);
            renderAutomation(automation, "automation-table");

            // Dashboard eigene kompakte "Letzte Activities"
            renderTimeline(timeline.slice(0, 50), "dashboard-latest-table");

            // Top Fenster nach Input (Client-seitig aus Timeline ableitbar, wenn Payload.app/title gesetzt)
            const inputEvents = timeline.filter(ev => ev.source === "input");
            const topMap = {};
            inputEvents.forEach(ev => {
                const p = ev.payload || {};
                const key = [p.app, p.title].filter(Boolean).join(" â€“ ") || "Unbekannt";
                topMap[key] = (topMap[key] || 0) + 1;
            });
            const topSorted = Object.entries(topMap).sort((a, b) => b[1] - a[1]).slice(0, 10);
            const tiBody = document.querySelector("#dashboard-top-input-windows tbody");
            if (tiBody) {
                tiBody.innerHTML = "";
                if (topSorted.length === 0) {
                    const tr = document.createElement("tr");
                    tr.innerHTML = '<td colspan="3" class="muted">Keine Input-Daten verfÃ¼gbar.</td>';
                    tiBody.appendChild(tr);
                } else {
                    topSorted.forEach(([key, count]) => {
                        const tr = document.createElement("tr");
                        tr.innerHTML = `
                            <td>${key}</td>
                            <td></td>
                            <td>${count}</td>
                        `;
                        tiBody.appendChild(tr);
                    });
                }
            }

            statusEl.textContent = "Letzte Aktualisierung: " + new Date().toLocaleTimeString("de-DE");
        } catch (e) {
            console.error(e);
            if (statusEl) statusEl.textContent = "Fehler beim Laden der Dashboard-Daten: " + e.message;
        }
    }

    async function loadWindows(range) {
        const statusEl = document.getElementById("status");
        try {
            const qs = rangeToQuery(range);
            statusEl.textContent = "Lade Fenster-Datenâ€¦";

            const top = await fetchJSON("/analysis/top-windows?limit=20&" + qs);
            renderTopWindows(top, "windows-top-table");

            const timeline = await fetchJSON("/analysis/timeline?source=window&limit=500&" + qs);
            renderTimeline(timeline, "windows-timeline-table", "window");

            // KPI-Berechnung
            let totalMinutes = 0;
            let appCount = 0;
            let topApp = "-";
            let switches = 0;

            if (Array.isArray(top) && top.length > 0) {
                appCount = top.length;
                totalMinutes = top.reduce((sum, r) => sum + (r.total_minutes || 0), 0);
                const sorted = [...top].sort((a, b) => (b.total_minutes || 0) - (a.total_minutes || 0));
                const best = sorted[0] || {};
                topApp = (best.app || "") + (best.title ? " â€“ " + best.title : "");
            }

            switches = Array.isArray(timeline) ? timeline.length : 0;

            const hr = totalMinutes / 60;
            const activeTimeEl = document.getElementById("win-kpi-active-time");
            if (activeTimeEl) activeTimeEl.textContent = hr ? hr.toFixed(1) + " h" : "â€“";
            const appCountEl = document.getElementById("win-kpi-app-count");
            if (appCountEl) appCountEl.textContent = appCount || "â€“";
            const topAppEl = document.getElementById("win-kpi-top-app");
            if (topAppEl) topAppEl.textContent = topApp || "â€“";
            const switchesEl = document.getElementById("win-kpi-switches");
            if (switchesEl) switchesEl.textContent = switches || "â€“";

            statusEl.textContent = "Letzte Aktualisierung: " + new Date().toLocaleTimeString("de-DE");
        } catch (e) {
            console.error(e);
            if (statusEl) statusEl.textContent = "Fehler beim Laden der Fenster-Daten: " + e.message;
        }
    }

    async function loadInputPage(range) {
        const statusEl = document.getElementById("status");
        try {
            const qs = rangeToQuery(range);
            statusEl.textContent = "Lade Input-Datenâ€¦";
            const data = await fetchJSON("/analysis/timeline?source=input&limit=1000&" + qs);
            renderInput(data, "input-table");

            let clicks = 0;
            let keys = 0;
            let scrolls = 0;
            const appCounts = {};

            (data || []).forEach(ev => {
                const t = ev.type;
                const p = ev.payload || {};
                if (t === "mouse_click_down") clicks++;
                if (t === "key_down") keys++;
                if (t === "mouse_scroll") scrolls++;

                const key = [p.app, p.title].filter(Boolean).join(" â€“ ") || "Unbekannt";
                appCounts[key] = (appCounts[key] || 0) + 1;
            });

            const clicksEl = document.getElementById("input-kpi-clicks");
            if (clicksEl) clicksEl.textContent = clicks || "â€“";
            const keysEl = document.getElementById("input-kpi-keystrokes");
            if (keysEl) keysEl.textContent = keys || "â€“";
            const scrollEl = document.getElementById("input-kpi-scrolls");
            if (scrollEl) scrollEl.textContent = scrolls || "â€“";

            const topEntry = Object.entries(appCounts).sort((a, b) => b[1] - a[1])[0];
            const topAppEl = document.getElementById("input-kpi-top-app");
            if (topAppEl) topAppEl.textContent = topEntry ? topEntry[0] : "â€“";

            statusEl.textContent = "Letzte Aktualisierung: " + new Date().toLocaleTimeString("de-DE");
        } catch (e) {
            console.error(e);
            if (statusEl) statusEl.textContent = "Fehler beim Laden der Input-Daten: " + e.message;
        }
    }

    async function loadDocumentsPage(range) {
        const statusEl = document.getElementById("status");
        try {
            const qs = rangeToQuery(range);
            statusEl.textContent = "Lade Dokument-Datenâ€¦";
            const data = await fetchJSON("/analysis/timeline?source=document&limit=1000&" + qs);
            renderDocuments(data, "document-table");

            let total = 0, created = 0, deleted = 0;
            const extCounts = {};

            (data || []).forEach(ev => {
                total++;
                if (ev.type === "created") created++;
                if (ev.type === "deleted") deleted++;
                const p = ev.payload || {};
                const path = p.path || "";
                const match = path.match(/\.[^\.\\\/]+$/);
                const ext = match ? match[0].toLowerCase() : "(ohne)";
                extCounts[ext] = (extCounts[ext] || 0) + 1;
            });

            const totalEl = document.getElementById("doc-kpi-total");
            if (totalEl) totalEl.textContent = total || "â€“";
            const createdEl = document.getElementById("doc-kpi-created");
            if (createdEl) createdEl.textContent = created || "â€“";
            const deletedEl = document.getElementById("doc-kpi-deleted");
            if (deletedEl) deletedEl.textContent = deleted || "â€“";

            const topExt = Object.entries(extCounts).sort((a, b) => b[1] - a[1])[0];
            const extEl = document.getElementById("doc-kpi-top-ext");
            if (extEl) extEl.textContent = topExt ? `${topExt[0]} (${topExt[1]})` : "â€“";

            statusEl.textContent = "Letzte Aktualisierung: " + new Date().toLocaleTimeString("de-DE");
        } catch (e) {
            console.error(e);
            if (statusEl) statusEl.textContent = "Fehler beim Laden der Dokument-Daten: " + e.message;
        }
    }

    async function loadScreenshotsPage(range) {
        const statusEl = document.getElementById("status");
        try {
            const qs = rangeToQuery(range);
            statusEl.textContent = "Lade Screenshot-Datenâ€¦";
            // Diese Endpoints kannst du im Backend ergÃ¤nzen:
            const summaryPromise = fetchJSON("/analysis/screenshots/summary?" + qs).catch(() => null);
            const listPromise = fetchJSON("/analysis/screenshots/list?limit=200&" + qs).catch(() => []);

            const summary = await summaryPromise;
            const list = await listPromise;

            renderScreenshots(list);

            if (summary) {
                const countEl = document.getElementById("ss-kpi-count");
                if (countEl) countEl.textContent = summary.count ?? "â€“";

                const intervalEl = document.getElementById("ss-kpi-interval");
                if (intervalEl) intervalEl.textContent =
                    summary.avg_interval_seconds != null ? summary.avg_interval_seconds.toFixed(0) + " s" : "â€“";

                const sizeEl = document.getElementById("ss-kpi-size");
                if (sizeEl) {
                    const mb = summary.total_size_bytes ? summary.total_size_bytes / (1024 * 1024) : 0;
                    sizeEl.textContent = mb ? mb.toFixed(2) + " MB" : "â€“";
                }

                const covEl = document.getElementById("ss-kpi-coverage");
                if (covEl) covEl.textContent =
                    summary.coverage_percent != null ? summary.coverage_percent.toFixed(0) + "%" : "â€“";
            }

            statusEl.textContent = "Letzte Aktualisierung: " + new Date().toLocaleTimeString("de-DE");
        } catch (e) {
            console.error(e);
            if (statusEl) statusEl.textContent = "Fehler beim Laden der Screenshot-Daten: " + e.message;
        }
    }

    async function loadBrowserPage(range) {
        const statusEl = document.getElementById("status");
        try {
            const qs = rangeToQuery(range);
            statusEl.textContent = "Lade Browser-Datenâ€¦";

            // Status & letzte Events
            await refreshBrowserCollector();

            // Browser-spezifische Summary (Endpoint optional)
            try {
                const summary = await fetchJSON("/analysis/browser/summary?" + qs);
                if (summary) {
                    const tabsEl = document.getElementById("br-kpi-tabs");
                    if (tabsEl) tabsEl.textContent = summary.tab_count ?? "â€“";
                    const plEl = document.getElementById("br-kpi-page-loads");
                    if (plEl) plEl.textContent = summary.page_loads ?? "â€“";
                    const clicksEl = document.getElementById("br-kpi-clicks");
                    if (clicksEl) clicksEl.textContent = summary.clicks ?? "â€“";
                    const domEl = document.getElementById("br-kpi-domains");
                    if (domEl) domEl.textContent = summary.domain_count ?? "â€“";
                }
            } catch (e) {
                console.warn("Browser summary not available:", e);
            }

            statusEl.textContent = "Letzte Aktualisierung: " + new Date().toLocaleTimeString("de-DE");
        } catch (e) {
            console.error(e);
            if (statusEl) statusEl.textContent = "Fehler beim Laden der Browser-Daten: " + e.message;
        }
    }

    const pageLoaders = {
        dashboard: loadDashboard,
        windows: loadWindows,
        input: loadInputPage,
        documents: loadDocumentsPage,
        screenshots: loadScreenshotsPage,
        browser: loadBrowserPage
        // settings braucht keinen Loader
    };

    // --- Browser Collector spezifisch ---
    function formatTime(dateStr) {
        const d = new Date(dateStr);
        return d.toLocaleTimeString("de-DE", {
            hour: "2-digit",
            minute: "2-digit",
            second: "2-digit",
        });
    }

    function formatRelativeSeconds(seconds) {
        if (seconds == null) return "â€“";
        if (seconds < 60) return `${Math.round(seconds)} s`;
        const mins = Math.floor(seconds / 60);
        const secs = Math.round(seconds % 60);
        return `${mins} min ${secs} s`;
    }

    function updateBrowserStatusUI(statusData) {
        const pill = document.getElementById("browser-status-pill");
        const lastEventEl = document.getElementById("browser-last-event");
        const lastDiffEl = document.getElementById("browser-last-diff");

        if (!pill || !lastEventEl || !lastDiffEl) return;

        pill.classList.remove("status-ok", "status-warn", "status-offline");
        pill.classList.add(`status-${statusData.status || "offline"}`);
        pill.textContent =
            statusData.status === "ok"
                ? "OK"
                : statusData.status === "warn"
                    ? "VerzÃ¶gert"
                    : "Offline";

        lastEventEl.textContent = statusData.last_event
            ? new Date(statusData.last_event).toLocaleString("de-DE")
            : "â€“";

        lastDiffEl.textContent = formatRelativeSeconds(
            statusData.seconds_since_last_event
        );
    }

    function renderBrowserCollectorTimeline(events) {
        const container = document.getElementById("browser-timeline");
        const countEl = document.getElementById("browser-event-count");
        if (!container || !countEl) return;

        container.innerHTML = "";
        countEl.textContent = `${events.length} EintrÃ¤ge`;

        if (!events || events.length === 0) {
            container.innerHTML = '<div class="muted" style="padding:8px 10px;">Noch keine Browser-AktivitÃ¤ten erfasst.</div>';
            return;
        }

        for (const ev of events) {
            const time = formatTime(ev.timestamp);
            const type = ev.type || "event";
            const url = ev.payload?.url || "";
            const title = ev.payload?.title || "";
            const dom = ev.payload?.dom_event || null;

            const item = document.createElement("div");
            item.className = "timeline-item";

            const timeEl = document.createElement("div");
            timeEl.className = "timeline-item-time";
            timeEl.textContent = time;

            const mainEl = document.createElement("div");
            mainEl.className = "timeline-item-main";

            const firstLine = document.createElement("div");

            const tag = document.createElement("span");
            tag.className = "timeline-item-tag";
            tag.textContent = type;

            const titleSpan = document.createElement("span");
            titleSpan.textContent = title || "(kein Titel)";

            firstLine.appendChild(tag);
            firstLine.appendChild(titleSpan);

            const urlLine = document.createElement("div");
            urlLine.className = "timeline-item-url";
            urlLine.textContent = url;

            mainEl.appendChild(firstLine);
            mainEl.appendChild(urlLine);

            if (dom && dom.event_type) {
                const domLine = document.createElement("div");
                domLine.className = "timeline-item-url";
                domLine.textContent = `DOM: ${dom.event_type} â€“ ${dom.element_tag || ""}#${dom.element_id || ""}`;
                mainEl.appendChild(domLine);
            }

            item.appendChild(timeEl);
            item.appendChild(mainEl);
            container.appendChild(item);
        }
    }

    async function refreshBrowserCollector() {
        try {
            const [status, events] = await Promise.all([
                fetchJSON("/collectors/browser/status"),
                fetchJSON("/events/browser/recent?limit=50"),
            ]);
            updateBrowserStatusUI(status);
            renderBrowserCollectorTimeline(events);
        } catch (e) {
            console.warn("Browser Collector UI Refresh failed", e);
        }
    }

    // --- Einstellungen ---
    async function loadSettings() {
        const status = document.getElementById("settings-status");
        if (!status) return;
        try {
            const data = await fetchJSON("/settings");
            const retentionInput = document.getElementById("retention-input");
            if (data && typeof data.screenshot_retention_days === "number" && retentionInput) {
                retentionInput.value = data.screenshot_retention_days;
            }
            status.textContent = "";
        } catch (e) {
            console.error(e);
            status.textContent = "Konnte Einstellungen nicht laden: " + e.message;
        }
    }

    async function saveSettings() {
        const status = document.getElementById("settings-status");
        const retentionInput = document.getElementById("retention-input");
        if (!retentionInput || !status) return;

        const days = parseInt(retentionInput.value, 10);
        if (isNaN(days) || days <= 0) {
            status.textContent = "Bitte eine gÃ¼ltige Anzahl Tage eingeben.";
            return;
        }

        try {
            status.textContent = "Speichere Einstellungenâ€¦";
            const res = await fetch("/settings", {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify({screenshot_retention_days: days})
            });
            if (!res.ok) throw new Error("HTTP " + res.status);
            status.textContent = "Einstellungen gespeichert.";
            setTimeout(() => status.textContent = "", 3000);
        } catch (e) {
            console.error(e);
            status.textContent = "Fehler beim Speichern: " + e.message;
        }
    }

    function buildExportUrl() {
        const fromEl = document.getElementById("date-from");
        const toEl = document.getElementById("date-to");
        const sourceEl = document.getElementById("source-filter");

        const params = new URLSearchParams();
        if (fromEl && fromEl.value) params.set("from", fromEl.value);
        if (toEl && toEl.value) params.set("to", toEl.value);
        if (sourceEl && sourceEl.value) params.set("source", sourceEl.value);

        return "/export?" + params.toString();
    }

    function triggerExport() {
        const status = document.getElementById("export-status");
        try {
            const url = buildExportUrl();
            if (status) status.textContent = "Export wird vorbereitetâ€¦";
            window.open(url, "_blank");
            setTimeout(() => {
                if (status) status.textContent = "";
            }, 3000);
        } catch (e) {
            console.error(e);
            if (status) status.textContent = "Fehler beim Starten des Exports: " + e.message;
        }
    }

    // --- Navigation & Filter-Init ---
    function setActivePage(page) {
        document.querySelectorAll(".page").forEach(p => p.classList.remove("active"));
        const targetEl = document.getElementById("page-" + page);
        if (targetEl) targetEl.classList.add("active");

        document.querySelectorAll(".nav-link").forEach(btn => {
            btn.classList.toggle("active", btn.getAttribute("data-target") === page);
        });

        // Beim Wechsel keine automatische Neuladung erzwingen â€“ Nutzer Ã¤ndert Filter nach Bedarf
    }

    function initFilters() {
        // Preset-Klicks
        document.querySelectorAll(".filter-btn").forEach(btn => {
            btn.addEventListener("click", () => {
                const page = btn.getAttribute("data-page");
                const preset = btn.getAttribute("data-preset");
                if (!page || !preset) return;

                // Aktiv-Status in der Button-Gruppe
                document.querySelectorAll(`.filter-btn[data-page="${page}"]`).forEach(b => {
                    b.classList.toggle("active", b === btn);
                });

                let range;
                let label = "";

                if (preset === "custom") {
                    // Nutzer soll Custom Ã¼ber "Anwenden" setzen
                    return;
                } else {
                    const mapping = {
                        today: "Heute",
                        week: "Woche",
                        month: "Monat",
                        quarter: "Quartal",
                        year: "Jahr"
                    };
                    label = mapping[preset] || preset;
                    range = getPresetRange(preset);
                }

                pageState[page] = { range, presetLabel: label };
                updateFilterSummary(page);

                const loader = pageLoaders[page];
                if (typeof loader === "function") {
                    loader(range);
                }
            });
        });

        // Custom-Apply
        document.querySelectorAll(".filter-apply").forEach(btn => {
            btn.addEventListener("click", () => {
                const page = btn.getAttribute("data-page");
                if (!page) return;
                const range = getCustomRange(page);
                if (!range) {
                    alert("Bitte gÃ¼ltigen benutzerdefinierten Zeitraum wÃ¤hlen.");
                    return;
                }
                pageState[page] = { range, presetLabel: "Custom" };
                updateFilterSummary(page);

                // Buttons entmarkieren + Custom markieren
                document.querySelectorAll(`.filter-btn[data-page="${page}"]`).forEach(b => {
                    const isCustom = b.getAttribute("data-preset") === "custom";
                    b.classList.toggle("active", isCustom);
                });

                const loader = pageLoaders[page];
                if (typeof loader === "function") {
                    loader(range);
                }
            });
        });

        // Standard: alle Seiten auf "Heute" initialisieren (wo es Filter gibt)
        const pagesWithFilter = ["dashboard", "windows", "input", "documents", "screenshots", "browser"];
        pagesWithFilter.forEach(page => {
            const range = getPresetRange("today");
            pageState[page] = { range, presetLabel: "Heute" };
            updateFilterSummary(page);
            const loader = pageLoaders[page];
            if (typeof loader === "function") {
                loader(range);
            }
        });
    }

    document.addEventListener("DOMContentLoaded", () => {
        initTheme();

        const themeBtn = document.getElementById("theme-toggle");
        if (themeBtn) {
            themeBtn.addEventListener("click", () => {
                const current = document.documentElement.getAttribute("data-theme") || "dark";
                const next = current === "dark" ? "light" : "dark";
                applyTheme(next);
            });
        }

        // Navigation
        document.querySelectorAll(".nav-link").forEach(btn => {
            btn.addEventListener("click", () => {
                const target = btn.getAttribute("data-target");
                if (!target) return;
                setActivePage(target);
                // Settings: bei Wechsel Einstellungen nachladen
                if (target === "settings") {
                    loadSettings();
                }
            });
        });

        // Settings-Buttons
        const saveBtn = document.getElementById("save-settings-btn");
        if (saveBtn) saveBtn.addEventListener("click", saveSettings);
        const exportBtn = document.getElementById("export-button");
        if (exportBtn) exportBtn.addEventListener("click", (e) => {
            e.preventDefault();
            triggerExport();
        });

        // Filter & erste Ladung
        initFilters();

        // Browser Collector regelmÃ¤ÃŸig aktualisieren (Timeline & Status)
        refreshBrowserCollector();
        setInterval(refreshBrowserCollector, 10000);
    });
</script>
</body>
</html>
